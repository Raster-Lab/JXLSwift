name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  checks: write

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macOS (ARM64)
            runner: macos-15
            swift-version: "6.2"
          - name: macOS (x86-64)
            runner: macos-15-intel
            swift-version: "6.2"
          - name: Linux (x86-64)
            runner: ubuntu-latest
            swift-version: "6.2"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: ${{ matrix.swift-version }}
          # Workaround: GPG signature verification fails on Linux due to missing public key
          skip-verify-signature: true

      - name: Swift version
        run: swift --version

      - name: Build
        run: swift build

      - name: Test
        run: swift test --parallel --skip Performance --skip Benchmark --skip MetalComputeTests --skip LibjxlCompatibilityTests --xunit-output test-results.xml --enable-code-coverage
        continue-on-error: true

      - name: Generate code coverage report
        if: runner.os == 'macOS'
        run: |
          xcrun llvm-cov export -format="lcov" \
            .build/debug/JXLSwiftPackageTests.xctest/Contents/MacOS/JXLSwiftPackageTests \
            -instr-profile .build/debug/codecov/default.profdata \
            > coverage.lcov || echo "Coverage generation failed (non-fatal)"
      
      - name: Publish test report
        uses: mikepenz/action-junit-report@v5
        if: always()
        with:
          report_paths: test-results.xml
          check_name: Test Report (${{ matrix.name }})

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.runner }}
          path: |
            test-results.xml
            coverage.lcov

      - name: Generate job summary
        if: always()
        run: |
          echo "## Build & Test Results â€” ${{ matrix.name }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Item | Detail |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Platform** | ${{ matrix.name }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Runner** | ${{ matrix.runner }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Swift** | ${{ matrix.swift-version }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ -f test-results.xml ]; then
            tests=$(grep -c '<testcase' test-results.xml || echo "0")
            failures=$(grep -c '<failure' test-results.xml || echo "0")
            echo "| **Tests run** | $tests |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Failures** | $failures |" >> "$GITHUB_STEP_SUMMARY"
            if [ "$failures" -eq 0 ]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "âœ… All tests passed." >> "$GITHUB_STEP_SUMMARY"
            else
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "âŒ $failures test(s) failed." >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "âš ï¸ No test results file found." >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ -f coverage.lcov ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "ðŸ“Š **Code coverage report generated**" >> "$GITHUB_STEP_SUMMARY"
          fi

  memory-safety:
    name: Memory Safety (${{ matrix.sanitizer }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - sanitizer: Address Sanitizer
            runner: ubuntu-latest
            swift-flags: "-sanitize=address"
          - sanitizer: Thread Sanitizer
            runner: ubuntu-latest
            swift-flags: "-sanitize=thread"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2"
          skip-verify-signature: true

      - name: Swift version
        run: swift --version

      - name: Build with ${{ matrix.sanitizer }}
        run: swift build -Xswiftc ${{ matrix.swift-flags }}

      - name: Test with ${{ matrix.sanitizer }}
        run: swift test -Xswiftc ${{ matrix.swift-flags }} --skip Performance --skip Benchmark --skip MetalComputeTests
        env:
          ASAN_OPTIONS: detect_leaks=0

      - name: Generate job summary
        if: always()
        run: |
          echo "## Memory Safety Results â€” ${{ matrix.sanitizer }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Item | Detail |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Sanitizer** | ${{ matrix.sanitizer }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Runner** | ${{ matrix.runner }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… No memory safety issues detected." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âŒ Memory safety issues detected. Check logs for details." >> "$GITHUB_STEP_SUMMARY"
          fi

  conformance:
    name: Conformance Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2"
          skip-verify-signature: true

      - name: Swift version
        run: swift --version

      - name: Install libjxl tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y libjxl-tools || echo "libjxl-tools not available; interoperability tests will be skipped"

      - name: Build
        run: swift build

      - name: Run conformance tests
        run: swift test --filter ConformanceTests --xunit-output conformance-results.xml
        continue-on-error: true

      - name: Publish conformance report
        uses: mikepenz/action-junit-report@v5
        if: always()
        with:
          report_paths: conformance-results.xml
          check_name: Conformance Report

      - name: Upload conformance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: conformance-results
          path: conformance-results.xml

      - name: Generate job summary
        if: always()
        run: |
          echo "## Conformance Testing Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Item | Detail |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Standard** | ISO/IEC 18181-3 |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Categories** | Bitstream, Header, Frame, Container, Round-trip |" >> "$GITHUB_STEP_SUMMARY"
          if command -v cjxl &>/dev/null && command -v djxl &>/dev/null; then
            echo "| **libjxl** | Available (interoperability tests enabled) |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| **libjxl** | Not available (interoperability tests skipped) |" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ -f conformance-results.xml ]; then
            tests=$(grep -c '<testcase' conformance-results.xml || echo "0")
            failures=$(grep -c '<failure' conformance-results.xml || echo "0")
            skipped=$(grep -c 'skipped' conformance-results.xml || echo "0")
            echo "| **Vectors run** | $tests |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Failures** | $failures |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Skipped** | $skipped |" >> "$GITHUB_STEP_SUMMARY"
            if [ "$failures" -eq 0 ]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "âœ… All conformance vectors passed." >> "$GITHUB_STEP_SUMMARY"
            else
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "âŒ $failures conformance vector(s) failed." >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "âš ï¸ No conformance results file found." >> "$GITHUB_STEP_SUMMARY"
          fi

  performance:
    name: Performance Regression Gate (Milestone 21)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2"
          skip-verify-signature: true

      - name: Swift version
        run: swift --version

      - name: Run Milestone 21 performance tests
        run: swift test --filter Milestone21Tests --xunit-output performance-results.xml
        # Advisory only: performance tests record throughput numbers but are not
        # expected to fail on CI runners (which are slower than developer hardware).
        # If a regression is detected on developer hardware, update the baselines
        # in PerformanceRegressionGate before merging.
        continue-on-error: true

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-results
          path: performance-results.xml

      - name: Generate job summary
        if: always()
        run: |
          echo "## Performance Regression Gate â€” Milestone 21" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Item | Detail |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Goal** | No PR merges with > 10% throughput slowdown |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Milestone** | 21 â€” Performance: Exceeding libjxl |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ -f performance-results.xml ]; then
            tests=$(grep -c '<testcase' performance-results.xml || echo "0")
            failures=$(grep -c '<failure' performance-results.xml || echo "0")
            echo "| **Tests run** | $tests |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Failures** | $failures |" >> "$GITHUB_STEP_SUMMARY"
            if [ "$failures" -eq 0 ]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "âœ… All performance gate tests passed." >> "$GITHUB_STEP_SUMMARY"
            else
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "âš ï¸ $failures performance test(s) reported regressions. Review throughput numbers." >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "âš ï¸ No performance results file found." >> "$GITHUB_STEP_SUMMARY"
          fi

  security:
    name: Security Scanning
    runs-on: macos-15
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: swift

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2"

      - name: Build for CodeQL
        run: swift build

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:swift"

      - name: Generate job summary
        if: always()
        run: |
          echo "## Security Scanning Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Item | Detail |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Scanner** | CodeQL |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Language** | Swift |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Security scan completed. Check Security tab for any findings." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âŒ Security scan failed. Check logs for details." >> "$GITHUB_STEP_SUMMARY"
          fi

  spelling:
    name: Spelling Consistency Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ripgrep
        run: |
          sudo apt-get install -y ripgrep
          chmod +x scripts/check-spelling.sh

      - name: Run spelling checker
        # Advisory only: report spelling inconsistencies without failing the build.
        # Many existing identifiers intentionally keep American spellings (e.g.
        # ColorSpace, colorSpace) because they are part of stable public API.
        # Run with --fix locally to auto-correct new occurrences in comments/docs.
        run: ./scripts/check-spelling.sh || true

      - name: Generate job summary
        if: always()
        run: |
          echo "## Spelling Consistency Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Item | Detail |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Standard** | British English |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Script** | scripts/check-spelling.sh |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if ./scripts/check-spelling.sh 2>/dev/null; then
            echo "âœ… No spelling inconsistencies found." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âš ï¸ Spelling inconsistencies detected. Run \`./scripts/check-spelling.sh --fix\` to auto-correct." >> "$GITHUB_STEP_SUMMARY"
          fi
